{"version":3,"sources":["../../../../src/profittable/profitTable.es6"],"names":["profitWin","table","currency","local_storage","get","datepicker","init","$menuLink","click","cached","authorize","then","initProfitWin","catch","err","console","error","growl","message","moveToTop","loading","options","offset","limit","is_specific_date_shown","refreshTable","yyyy_mm_dd","processing_msg","attr","css","show","request","profit_table","description","sort","date_from","yyyy_mm_dd_to_epoch","utc","one_day_utc","Date","UTC","date_to","api","rows","remove","clear","column","data","length","refresh","transactions","map","trans","profit","parseFloat","sell_price","buy_price","toFixed","view_button","i18n","epoch_to_string","purchase_time","transaction_id","longcode","formatPrice","sell_time","add","draw","hide","send","on_arrow_click","e","target","$target","tagName","hasClass","tr","parentElement","transaction","row","last","addClass","contract_id","removeClass","createBlankWindow","title","width","height","destroy","DataTable","track","module_id","is_unique","appendTo","footer","dataTable","columnDefs","targets","createdCell","td","cellData","css_class","textContent","info","footerCallback","start","end","display","total","reduce","a","b","html","paging","ordering","searching","processing","parent","columns","every","header","on","search","value","addDateToHeader","date","changed","cleared","dialog","scroll","scrollTop","innerHeight","scrollHeight","postion"],"mappings":"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","file":"profitTable.js","sourcesContent":["ï»¿/**\n * Created by amin on October 29, 2015.\n */\nimport $ from  \"jquery\";\nimport _ from \"lodash\";\nimport windows from \"../windows/windows\";\nimport liveapi from \"../websockets/binary_websockets\";\nimport viewTransaction from '../viewtransaction/viewTransaction';\nimport \"datatables\";\nimport \"jquery-growl\";\nimport '../common/util';\nimport \"css!./profitTable.css\";\nimport html from 'text!./profitTable.html';\n\nlet profitWin = null,\n   table = null,\n   currency = local_storage.get(\"currency\"),\n   datepicker = null;\n\nexport const init = ($menuLink) => {\n   $menuLink.click(() => {\n      if (!profitWin)\n         liveapi.cached.authorize()\n            .then(initProfitWin)\n            .catch((err) => {\n               console.error(err);\n               $.growl.error({ message: err.message });\n            });\n      else\n         profitWin.moveToTop();\n   });\n}\n\nlet loading = false;\nconst options = { offset : 0, limit: 200 };\nlet is_specific_date_shown = false; /* is data for a specific date is shown */\n\nconst refreshTable = (yyyy_mm_dd) => {\n   const processing_msg = $('#' + table.attr('id') + '_processing').css('top','200px').show();\n   loading = true;\n\n   const request = {\n      profit_table: 1,\n      description: 1,\n      sort: 'DESC'\n   };\n\n   /* if a date is specified get the transactions for that date */\n   if (typeof yyyy_mm_dd === 'string') {\n      request.date_from = yyyy_mm_dd_to_epoch(yyyy_mm_dd, { utc: true });\n      const one_day_utc = Date.UTC(1970, 0, 1, 23, 59, 59) / 1000;\n      request.date_to = request.date_from + one_day_utc;\n      table.api().rows().remove();\n      is_specific_date_shown = true;\n   }\n   else  { /* request the next 50 items for live scroll */\n      request.limit = 50;\n      if(is_specific_date_shown || yyyy_mm_dd.clear) {\n         table.api().rows().remove();\n         is_specific_date_shown = false;\n      }\n      request.offset = table.api().column(0).data().length;\n   }\n\n   /* refresh the table with result of { profit_table:1 } from WS */\n   const refresh = (data) => {\n      const transactions = (data.profit_table && data.profit_table.transactions) || [];\n      const rows = transactions.map((trans) => {\n         const profit = (parseFloat(trans.sell_price) - parseFloat(trans.buy_price)).toFixed(2); /* 2 decimal points */\n         const view_button = '<button>View</button>'.i18n();\n         return [\n            epoch_to_string(trans.purchase_time, { utc: true }),\n            trans.transaction_id,\n            trans.longcode,\n            formatPrice(trans.buy_price,currency),\n            epoch_to_string(trans.sell_time, { utc: true }),\n            formatPrice(trans.sell_price,currency),\n            profit,\n            view_button,\n            trans, /* we will use it when handling arrow clicks to show view transaction dialog */\n         ];\n      });\n      table.api().rows.add(rows);\n      table.api().draw();\n      loading = false;\n      processing_msg.hide();\n   };\n\n   liveapi.send(request)\n      .then(refresh)\n      .catch((err) => {\n         refresh({});\n         $.growl.error({ message: err.message });\n         console.error(err);\n      });\n}\n\nconst on_arrow_click = (e) =>{\n   const target = e.target;\n   const $target = $(target);\n   if(target.tagName !== 'BUTTON' || $target.hasClass('button-disabled'))\n      return;\n   const tr = target.parentElement.parentElement;\n   let transaction = table.api().row(tr).data();\n   transaction = _.last(transaction);\n   $target.addClass('button-disabled');\n   viewTransaction.init(transaction.contract_id, transaction.transaction_id)\n      .then(\n         () =>$target.removeClass('button-disabled')\n      );\n}\n\nconst initProfitWin = () => {\n   profitWin = windows.createBlankWindow($('<div/>'), {\n      title: 'Profit Table'.i18n(),\n      width: 700 ,\n      height: 400,\n      destroy: () => {\n         table && table.DataTable().destroy(true);\n         profitWin = null;\n      },\n      refresh: () => {\n         datepicker.clear();\n         refreshTable({clear:true});\n      },\n      'data-authorized': 'true'\n   });\n   profitWin.track({\n      module_id: 'profitTable',\n      is_unique: true,\n      data: null\n   });\n\n   table = $(html).i18n();\n   table.appendTo(profitWin);\n   const footer = $('<div/>').addClass('profit-table-info');\n\n   table = table.dataTable({\n      data: [],\n      columnDefs: [ {\n         targets: 6,\n         createdCell: (td, cellData) => {\n            const css_class = (cellData < 0) ? 'red' : (cellData > 0) ? 'green' : 'bold';\n            if (css_class)\n               $(td).addClass(css_class);\n            $(td).attr(\"data-src\", cellData);\n            td.textContent = formatPrice(cellData,currency);\n         }\n      }],\n      info: false,\n      footerCallback: function ( row, data, start, end, display ) {\n         const api = this.api();\n\n         const total = api.column(6).data()\n            .reduce((a, b) => (a*1 + b*1), 0);\n\n         const css = 'total ' + (total >= 0 ? 'green' : 'red');\n         footer.html(\n            '<span class=\"title\">Total Profit/Loss<span>' +\n            '<span class=\"' + css + '\">'+ formatPrice(total,currency) +'</span>'\n         );\n      },\n      paging: false,\n      ordering: false,\n      searching: true,\n      processing: true\n   });\n   footer.i18n().appendTo(table.parent());\n   table.parent().addClass('hide-search-input');\n\n   // Apply the a search on each column input change\n   table.api().columns().every(function () {\n      const column = this;\n      $('input', this.header()).on('keyup change', function () {\n         if (column.search() !== this.value)\n            column.search(this.value) .draw();\n      });\n   });\n\n   refreshTable({clear: true});\n   datepicker = profitWin.addDateToHeader({\n      title: 'Jump to: '.i18n(),\n      date: null, /* set date to null */\n      changed: refreshTable,\n      cleared: refreshTable\n   });\n\n   profitWin.dialog('open');\n   profitWin.on('click', on_arrow_click);\n\n   /**************** infinite scroll implementation *******************/\n   profitWin.scroll(() => {\n      const scrollTop = profitWin.scrollTop(),\n         innerHeight = profitWin.innerHeight(),\n         scrollHeight = profitWin[0].scrollHeight,\n         postion = (scrollTop + innerHeight) / scrollHeight;\n      if(postion > 0.75 && !loading && !is_specific_date_shown){\n         refreshTable({clear:false});\n      }\n   });\n}\n\nexport default { init }\n"]}