{"version":3,"sources":["../../../../src/cashier/deposit.es6"],"names":["init","require","deposit_win","deposit_win_view","error_handler","err","console","error","growl","message","li","click","cached","authorize","then","data","currency","check_currency","init_deposit_win","catch","moveToTop","root","i18n","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","height","close","dialog","trigger","remove","open","destroy","unbind","init_state","offset","top","my","left","at","css","fixFooterPosition","track","module_id","is_unique","app_id","state","route","value","empty_fields","validate","clear","debounce","show","user","email","local_storage","get","cashier_url","residence","residence_name","standard_methods","iframe_visible","payment_agents","list","current","update","iframe_loaded","get_commission_text","agent","deposit_commission","withdrawal_commission","onclick","e","elem","target","next","cur_elem","is_active","scrollHeight","bind","send","cashier","residence_promise","get_settings","country_code","country","paymentagent_list","map","commission_text","supported_banks","toLowerCase","split"],"mappings":"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","file":"deposit.js","sourcesContent":["/*\n * Created by amin on June 26, 2016.\n */\n\nimport $ from 'jquery';\nimport liveapi from 'websockets/binary_websockets';\nimport windows from 'windows/windows';\nimport currencyDialog from 'cashier/currency';\nimport rv from 'common/rivetsExtra';\nimport _ from 'lodash';\nimport moment from 'moment';\n\nrequire(['text!cashier/deposit.html']);\nrequire(['css!cashier/deposit.css']);\nlet deposit_win = null;\nlet deposit_win_view = null; // rivets view\n\nconst error_handler = function(err) {\n  console.error(err);\n  $.growl.error({ message: err.message });\n};\n\nexport function init(li) {\n  li.click(() => {\n      if(!deposit_win) {\n          liveapi.cached.authorize().then(data => {\n            if(!data.authorize.currency) // if currency is not set ask for currency\n              return currencyDialog.check_currency();\n            return true; // OK\n          })\n          .then(() => require(['text!cashier/deposit.html'], init_deposit_win))\n          .catch(error_handler);\n      }\n      else\n        deposit_win.moveToTop();\n  });\n}\n\nfunction init_deposit_win(root) {\n  root = $(root).i18n();\n  deposit_win = windows.createBlankWindow(root, {\n      title: 'Deposit funds',\n      resizable: true,\n      collapsable: false,\n      minimizable: true,\n      maximizable: true,\n      width: 700,\n      height: 600,\n      'data-authorized': true,\n      close: function () {\n        deposit_win.dialog('destroy');\n        deposit_win.trigger('dialogclose'); // TODO: figure out why event is not fired.\n        deposit_win.remove();\n        deposit_win = null;\n      },\n      open: function () { },\n      destroy: function() {\n        deposit_win_view && deposit_win_view.unbind();\n        deposit_win_view = null;\n      }\n  });\n\n  init_state(root);\n  deposit_win.dialog('open');\n\n  /* update dialog position, this way when dialog is resized it will not move*/\n  var offset = deposit_win.dialog('widget').offset();\n  offset.top = 110;\n  deposit_win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\n  deposit_win.dialog('widget').css({\n      left: offset.left + 'px',\n      top: offset.top + 'px'\n  });\n  deposit_win.fixFooterPosition();\n  deposit_win.track({\n    module_id: 'deposit',\n    is_unique: true\n  });\n}\n\nfunction init_state(root) {\n  var app_id = liveapi.app_id;\n  var state = {\n    route: { value: 'standard-methods'},\n    empty_fields: {\n      validate: false,\n      clear: _.debounce(function() {\n        state.empty_fields.validate = false;\n      }, 4000),\n      show: function() {\n        state.empty_fields.validate = true;\n        state.empty_fields.clear();\n      }\n    },\n    user: {\n      email: local_storage.get('authorize').email,\n      cashier_url:'',\n      residence: '',\n      residence_name: ''\n    },\n    standard_methods: {\n      iframe_visible: false,\n    },\n    payment_agents: {\n      list: [],\n      current: {}\n    }\n  };\n\n  state.route.update = route => { state.route.value = route; };\n\n  state.standard_methods.iframe_loaded = function() {\n    if(state.user.cashier_url)\n      state.standard_methods.iframe_visible = true;\n  }\n\n  state.payment_agents.get_commission_text = function(agent) {\n    if(agent.deposit_commission === agent.withdrawal_commission) {\n        return agent.deposit_commission + '% ' + 'commission'.i18n();\n    }\n    return agent.deposit_commission + '% ' + 'deposits'.i18n() + ' / ' +\n           agent.withdrawal_commission + '% ' + 'withdrawals'.i18n();\n  }\n  state.payment_agents.onclick = function(agent, e){\n    var elem = $(e.target).next();\n    var cur_elem = state.payment_agents.elem;\n    cur_elem && cur_elem.css('max-height', '0');\n    state.payment_agents.current.is_active = false;\n    if(state.payment_agents.current === agent) {\n      state.payment_agents.current = {};\n    }\n    else {\n      state.payment_agents.current = agent;\n      state.payment_agents.elem = elem;\n      elem.css('max-height', elem[0].scrollHeight + 'px');\n      agent.is_active = true;\n    }\n  }\n\n  deposit_win_view = rv.bind(root[0], state);\n\n  /* get the cashier_url */\n  liveapi.send({\n    cashier: 'deposit'\n  }).then(function(data) {\n      state.user.cashier_url = data.cashier;\n  }).catch(error_handler);\n\n  /* get the residence field and its states */\n  var residence_promise = liveapi.send({get_settings: 1})\n         .then(function(data){\n           state.user.residence = data.get_settings.country_code;\n           state.user.residence_name = data.get_settings.country;\n         })\n         .catch(error_handler);\n\n  /* get payment agents list */\n  residence_promise.then(function() {\n    if(!state.user.residence)\n      return { paymentagent_list: { list: [] } };\n    return liveapi.send({paymentagent_list: state.user.residence });\n  }).then(function(data){\n    var list = data.paymentagent_list.list.map(function(agent){\n      agent.commission_text = state.payment_agents.get_commission_text(agent);\n      agent.supported_banks = agent.supported_banks.toLowerCase().split(',');\n      return agent;\n    })\n    state.payment_agents.list = list;\n  }).catch(error_handler);\n}\n\nexport default {\n  init: init\n}\n"]}