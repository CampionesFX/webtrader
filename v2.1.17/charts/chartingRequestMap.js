define(["exports","lokijs","lodash","jquery","websockets/binary_websockets","jquery-growl","common/util"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.digits_after_decimal=a.removeChart=a.unregister=a.subscribe=a.register=a.keyFor=a.processOHLC=a.barsLoaded=a.barsTable=void 0;var g=f(b),h=f(c),i=f(d),j=f(e),k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},l=new g["default"],m=a.barsTable=l.addCollection("bars_table"),n=a.barsLoaded=function(a){var b=a;if(this[b]&&this[b].chartIDs)for(var c=this[b].chartIDs,d=this.processOHLC,e=0;e<c.length;e++){var f=c[e];if(!f)return;if(!i["default"](f.containerIDWithHash).highcharts())return;var g=i["default"](f.containerIDWithHash).highcharts().get(b),h=i["default"](f.containerIDWithHash).data("type"),j=i["default"](f.containerIDWithHash).data("timePeriod");if(g){var l=function(){var a=g.data[g.data.length-1]&&(g.data[g.data.length-1].x||g.data[g.data.length-1].time);if(!a)return{v:void 0};var c=m.chain().find({instrumentCdAndTp:b}).where(function(b){return b.time>=a}).simplesort("time",!1).data();for(var d in c){for(var e=c[d],f=void 0,i=g.data.length-1;i>=0;i--){var j=g.data[i];if(j&&e.time==(j.x||j.time)){f=j;break}}f?h&&isDataTypeClosePriceOnly(h)?f.update([e.time,e.close],!1):f.update([e.time,e.open,e.high,e.low,e.close],!1):h&&isDataTypeClosePriceOnly(h)?g.addPoint([e.time,e.close],!1,!0):g.addPoint([e.time,e.open,e.high,e.low,e.close],!1,!0)}g.isDirty=!0,g.isDirtyData=!0,g.chart.redraw()}();if("object"===("undefined"==typeof l?"undefined":k(l)))return l.v}else{var n=function(){var a=i["default"](f.containerIDWithHash).highcharts(),c=[],e=m.chain().find({instrumentCdAndTp:b}).simplesort("time",!1).data();for(var g in e)d(e[g].open,e[g].high,e[g].low,e[g].close,e[g].time,h,c);if(!a||0===c.length)return{v:void 0};var k=30;isTick(j)&&(k=200);var l=c.length,n=c.length>k?l-k:0,o=f.instrumentName,p=f.series_compare,q=0;a.series.forEach(function(a){a.options.isInstrument&&"navigator"!==a.options.id&&++q}),0===q&&(a.xAxis[0].range=c[l-1][0]-c[n][0]);var r={id:b,name:o,data:c,type:h?h:"candlestick",dataGrouping:{enabled:!1},compare:p,states:{hover:{enabled:!1}},isInstrument:!0};(isLineDotType(h)||isDotType(h))&&(r.type="line",isDotType(h)&&(r.dashStyle="dot"),r.marker={enabled:!isDotType(h),radius:4}),a.addSeries(r)}();if("object"===("undefined"==typeof n?"undefined":k(n)))return n.v}}},o=a.processOHLC=function(a,b,c,d,e,f,g){if(!(g.length>0&&g[g.length-1][0]>e))if(f&&isDataTypeClosePriceOnly(f)){if(!i["default"].isNumeric(e)||!i["default"].isNumeric(d))return;g.push([e,d])}else{if(!(i["default"].isNumeric(e)&&i["default"].isNumeric(a)&&i["default"].isNumeric(b)&&i["default"].isNumeric(c)&&i["default"].isNumeric(d)))return;g.push([e,a,b,c,d])}},p=a.keyFor=function(a,b){var c=b||0;return"string"==typeof c&&(c=convertToTimeperiodObject(c).timeInSeconds()),(a+c).toUpperCase()},q=a.register=function(a){var b=this,c=b.keyFor(a.symbol,a.granularity),d=a.granularity||0,e=0!=d&&a.style?a.style:"ticks",f=!0;"string"==typeof d&&("0"==i["default"].trim(d)||("1t"==i["default"].trim(d).toLowerCase()?d=convertToTimeperiodObject(d).timeInSeconds():(f=!1,d=convertToTimeperiodObject(d).timeInSeconds())));var g={ticks_history:a.symbol,granularity:d,count:a.count||1,end:"latest",style:e};if(1===a.subscribe&&(g.subscribe=1),!f){var h=a.count||1,k=(new Date).getTime()/1e3-h*d|0,l=new Date;l.setUTCFullYear(l.getUTCFullYear()-3),l.setDate(l.getDate()+1),1e3*k<l.getTime()&&(k=l.getTime()/1e3|0),g.style="candles",g.start=k,g.adjust_start_time=a.adjust_start_time||1}return b[c]={symbol:a.symbol,granularity:d,subscribers:0,chartIDs:[]},g.subscribe&&(b[c].subscribers=1),j["default"].send(g,3e4)["catch"](function(d){if(g.subscribe&&"MarketIsClosed"==d.code)return i["default"].growl.notice({message:a.symbol+" market is presently closed.".i18n()}),delete g.subscribe,b[c].subscribers-=1,j["default"].send(g,3e4);throw delete b[c],d})},r=a.subscribe=function(a,b){var c=this;c[a]&&(c[a].subscribers+=1,b&&c[a].chartIDs.push(b))},s=a.unregister=function(a,b){var c=this;if(c[a]){b&&h["default"].remove(c[a].chartIDs,{containerIDWithHash:b}),c[a].subscribers-=1,0===c[a].chartIDs.length&&c[a].timerHandler&&(clearInterval(c[a].timerHandler),c[a].timerHandler=null);var d=c[a].symbol,e=c[c.keyFor(d,0)]&&c[c.keyFor(d,0)].subscribers;0===c[a].subscribers&&c[a].id&&j["default"].send({forget:c[a].id}).then(function(){e&&c.register({symbol:d,granularity:0,subscribe:1,count:50})})["catch"](function(a){}),0===c[a].subscribers&&delete c[a]}},t=a.removeChart=function(a,b){var c=this;c[a]&&h["default"](c[a].chartIDs).map("containerIDWithHash").includes(b)&&(c[a].subscribers-=1,h["default"].remove(c[a].chartIDs,{containerIDWithHash:b}))},u=a.digits_after_decimal=function(a,b){if(a=a&&a+"",!a){var c=this.keyFor(b,0),d=0;return m.chain().find({instrumentCdAndTp:c}).simplesort("time",!0).limit(10).data().forEach(function(a){var b=a.close+"",c=b.substring(b.indexOf(".")+1).length;c>d&&(d=c)}),d}return a.substring(a.indexOf(".")+1).length};a["default"]={barsLoaded:n,processOHLC:o,keyFor:p,barsTable:m,register:q,subscribe:r,unregister:s,removeChart:t,digits_after_decimal:u}});