{"version":3,"sources":["../../../../src/charts/chartingRequestMap.es6"],"names":["db","barsTable","addCollection","barsLoaded","instrumentCdAndTp","key","chartIDs","chartIDList","processOHLC","i","length","chartID","containerIDWithHash","highcharts","series","get","type","data","timePeriod","lastBarOpenTime","x","time","db_bars","chain","find","where","obj","simplesort","index","dbBar","foundBar","undefined","indx","value","isDataTypeClosePriceOnly","update","close","open","high","low","addPoint","isDirty","isDirtyData","chart","redraw","dataInHighChartsFormat","barIndex","numberOfBarsToShow","isTick","totalLength","endIndex","instrumentName","series_compare","countInstrumentCharts","forEach","options","isInstrument","id","xAxis","range","seriesConf","name","dataGrouping","enabled","compare","states","hover","isLineDotType","isDotType","dashStyle","marker","radius","addSeries","isNumeric","push","keyFor","symbol","granularity_or_timeperiod","granularity","convertToTimeperiodObject","timeInSeconds","toUpperCase","register","map","style","is_tick","trim","toLowerCase","req","count","subscribe","start","Date","getTime","_3YearsBack","setUTCFullYear","getUTCFullYear","setDate","getDate","adjust_start_time","subscribers","send","catch","up","code","growl","notice","message","i18n","unregister","remove","timerHandler","clearInterval","instrument","tickSubscribers","forget","then","err","console","error","removeChart","includes","digits_after_decimal","pip","warn","decimal_digits","limit","d","quote","len","substring","indexOf"],"mappings":"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","file":"chartingRequestMap.js","sourcesContent":["﻿/**\n * Created by amin on October 15,2015.\n */\n\n/**\n    Key is instrumentCode+timePeriod(in seconds), Value is\n        {\n            timerHandler : ,\n            chartIDs : [\n                {\n                    containerIDWithHash : containerIDWithHash,\n                    series_compare : series_compare,\n                    instrumentCode : instrumentCode,\n                    instrumentName : instrumentName\n                }\n            ]\n        }\n**/\nimport loki from 'lokijs';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport liveapi from 'websockets/binary_websockets';\nimport 'jquery-growl';\nimport 'common/util';\n\nconst db = new loki();\nexport const barsTable = db.addCollection('bars_table');\n// TODO: add common tasks for chartingRequestMap to this module\n//       move code from charts.js, ohlc_handler.js, stream_handler.js and symbol_handler.js\n\n\nexport const barsLoaded = function(instrumentCdAndTp) {\n\n    const key = instrumentCdAndTp;\n    if (!this[key] || !this[key].chartIDs) return;\n\n    const chartIDList = this[key].chartIDs;\n    const processOHLC = this.processOHLC;\n\n    for(let i =0;i<chartIDList.length;i++){\n        let chartID = chartIDList[i];\n        if (!chartID) return;\n        if (!$(chartID.containerIDWithHash).highcharts()) return;\n        const series = $(chartID.containerIDWithHash).highcharts().get(key),\n            type = $(chartID.containerIDWithHash).data('type'),\n            timePeriod = $(chartID.containerIDWithHash).data('timePeriod');\n\n        if (series) { //Update mode\n\n            const lastBarOpenTime = series.data[series.data.length - 1] && (series.data[series.data.length - 1].x || series.data[series.data.length - 1].time);\n            if(!lastBarOpenTime) return;\n            const db_bars = barsTable\n                .chain()\n                .find({ instrumentCdAndTp: key })\n                .where((obj) => {\n                    return obj.time >= lastBarOpenTime;\n                })\n                .simplesort('time', false).data();\n\n            for (let index in db_bars) {\n                const dbBar = db_bars[index];\n                //If the bar already exists, then update it, else add a new bar\n                let foundBar = undefined;\n                for (let indx = series.data.length - 1; indx >= 0; indx--) {\n                    const value = series.data[indx];\n                    if (value && dbBar.time == (value.x || value.time)) {\n                        foundBar = value;\n                        break;\n                    }\n                }\n                if (foundBar) {\n                    if (type && isDataTypeClosePriceOnly(type)) {\n                        foundBar.update([dbBar.time, dbBar.close], false);\n                    } else {\n                        foundBar.update([dbBar.time, dbBar.open, dbBar.high, dbBar.low, dbBar.close], false);\n                    }\n                } else {\n                    if (type && isDataTypeClosePriceOnly(type)) {\n                        series.addPoint([dbBar.time, dbBar.close], false, true);\n                    } else {\n                        series.addPoint([dbBar.time, dbBar.open, dbBar.high, dbBar.low, dbBar.close], false, true);\n                    }\n                }\n            }\n            //We have to mark it dirty because for OHLC, Highcharts leave some weird marks on chart that do not belong to OHLC\n            series.isDirty = true;\n            series.isDirtyData = true;\n            series.chart.redraw();\n\n        } else {\n\n            //First time rendering\n            const chart = $(chartID.containerIDWithHash).highcharts();\n            //We just want to get bars which are after the last complete rendered bar on chart(excluding the currently forming bar because that might change its values)\n            const dataInHighChartsFormat = [];\n\n            const db_bars = barsTable\n                .chain()\n                .find({ instrumentCdAndTp: key })\n                .simplesort('time', false)\n                .data();\n            for (const barIndex in db_bars) {\n                processOHLC(db_bars[barIndex].open, db_bars[barIndex].high, db_bars[barIndex].low, db_bars[barIndex].close,\n                    db_bars[barIndex].time, type, dataInHighChartsFormat);\n            }\n\n            if (!chart || dataInHighChartsFormat.length === 0) return;\n\n            //set the range\n            let numberOfBarsToShow = 30;\n            if (isTick(timePeriod)) numberOfBarsToShow = 200;\n            const totalLength = dataInHighChartsFormat.length;\n            const endIndex = dataInHighChartsFormat.length > numberOfBarsToShow ? totalLength - numberOfBarsToShow : 0;\n\n            const instrumentName = chartID.instrumentName;\n            const series_compare = chartID.series_compare;\n\n            //Find out how many instrument series are loaded on chart\n            let countInstrumentCharts = 0;\n            chart.series.forEach((series) => {\n                if (series.options.isInstrument && series.options.id !== \"navigator\") {\n                    ++countInstrumentCharts;\n                }\n            });\n            if (countInstrumentCharts === 0) {\n                chart.xAxis[0].range = dataInHighChartsFormat[totalLength - 1][0] - dataInHighChartsFormat[endIndex][0]; //show 30 bars\n            }\n\n            const seriesConf = {\n                id: key,\n                name: instrumentName,\n                data: dataInHighChartsFormat,\n                type: type ? type : 'candlestick', //area, candlestick, line, areaspline, column, ohlc, scatter, dot, linedot\n                dataGrouping: {\n                    enabled: false\n                },\n                compare: series_compare,\n                states: {\n                    hover: {\n                        enabled: false\n                    }\n                },\n                isInstrument: true //Its our variable\n            };\n            if (isLineDotType(type) || isDotType(type)) {\n                seriesConf.type = 'line';\n                if (isDotType(type)) {\n                    seriesConf.dashStyle = 'dot';\n                }\n                seriesConf.marker = {\n                    enabled: !isDotType(type),\n                    radius: 4\n                };\n            }\n            chart.addSeries(seriesConf);\n\n        }\n\n    };\n\n}\n\nexport const processOHLC = (open, high, low, close, time, type, dataInHighChartsFormat) => {\n    //Ignore if last known bar time is greater than this new bar time\n    if (dataInHighChartsFormat.length > 0 && dataInHighChartsFormat[dataInHighChartsFormat.length - 1][0] > time) return;\n\n    if (type && isDataTypeClosePriceOnly(type)) {\n        if (!$.isNumeric(time) || !$.isNumeric(close)) return;\n        dataInHighChartsFormat.push([time, close]);\n    } else {\n        if (!$.isNumeric(time) || !$.isNumeric(open) || !$.isNumeric(high) || !$.isNumeric(low) || !$.isNumeric(close)) return;\n        dataInHighChartsFormat.push([time, open, high, low, close]);\n    }\n}\n\nexport const keyFor = (symbol, granularity_or_timeperiod) => {\n    let granularity = granularity_or_timeperiod || 0;\n    if (typeof granularity === 'string') {\n        granularity = convertToTimeperiodObject(granularity).timeInSeconds();\n    }\n    return (symbol + granularity).toUpperCase();\n}\n\n/*  options: {\n      symbol,\n      granularity: // could be a number or a string in 1t, 2m, 3h, 4d format.\n                   // if a string is present it will be converted to seconds\n      subscribe: // default = 1,\n      style: // default = 'ticks',\n      count: // default = 1,\n      adjust_start_time?: // only will be added to the request if present\n    }\n    will return a promise\n*/\n\n\nexport const register = function(options) {\n    const map = this;\n    const key = map.keyFor(options.symbol, options.granularity);\n\n    let granularity = options.granularity || 0;\n    //If granularity = 0, then style should be ticks\n    const style = (granularity == 0 || !options.style) ? 'ticks' : options.style;\n\n    let is_tick = true;\n    if (typeof granularity === 'string') {\n        if ($.trim(granularity) == '0') {} else if ($.trim(granularity).toLowerCase() == '1t') {\n            granularity = convertToTimeperiodObject(granularity).timeInSeconds();\n        } else {\n            is_tick = false;\n            granularity = convertToTimeperiodObject(granularity).timeInSeconds();\n        }\n    }\n\n    const req = {\n        \"ticks_history\": options.symbol,\n        \"granularity\": granularity,\n        \"count\": options.count || 1,\n        \"end\": 'latest',\n        \"style\": style\n    };\n    if (options.subscribe === 1) {\n        req.subscribe = 1;\n    }\n\n    if (!is_tick) {\n        const count = options.count || 1;\n        let start = (new Date().getTime() / 1000 - count * granularity) | 0;\n\n        //If the start time is less than 3 years, adjust the start time\n        const _3YearsBack = new Date();\n        _3YearsBack.setUTCFullYear(_3YearsBack.getUTCFullYear() - 3);\n        //Going back exactly 3 years fails. I am adding 1 day\n        _3YearsBack.setDate(_3YearsBack.getDate() + 1);\n\n        if ((start * 1000) < _3YearsBack.getTime()) { start = (_3YearsBack.getTime() / 1000) | 0; }\n\n        req.style = 'candles';\n        req.start = start;\n        req.adjust_start_time = options.adjust_start_time || 1;\n    }\n\n    map[key] = { symbol: options.symbol, granularity: granularity, subscribers: 0, chartIDs: [] };\n    if (req.subscribe) map[key].subscribers = 1; // how many charts have subscribed for a stream\n    return liveapi.send(req, /*timeout:*/ 30 * 1000) // 30 second timeout\n        .catch((up) => {\n            /* if the market is closed try the same request without subscribing */\n            if (req.subscribe && up.code == 'MarketIsClosed') {\n                $.growl.notice({ message: options.symbol + ' market is presently closed.'.i18n() });\n                delete req.subscribe;\n                map[key].subscribers -= 1;\n                return liveapi.send(req, 30 * 1000);\n            }\n            delete map[key];\n            throw up;\n        });\n}\n\n/* use this method if there is already a stream with this key registered,\n  if you are counting on a registered stream and don't call this method that stream might be removed,\n  when all dependent modules call unregister function.\n  you should also make sure to call unregister when you no longer need the stream to avoid \"stream leack!\" */\nexport const subscribe = function(key, chartID) {\n    const map = this;\n    if (!map[key]) {\n        return;\n    }\n    map[key].subscribers += 1;\n    if (chartID) {\n        map[key].chartIDs.push(chartID);\n    }\n}\n\nexport const unregister = function(key, containerIDWithHash) {\n    const map = this;\n    if (!map[key]) {\n        return;\n    }\n    if (containerIDWithHash) {\n        _.remove(map[key].chartIDs, { containerIDWithHash: containerIDWithHash });\n    }\n    map[key].subscribers -= 1;\n    if (map[key].chartIDs.length === 0 && map[key].timerHandler) {\n        clearInterval(map[key].timerHandler);\n        map[key].timerHandler = null;\n    }\n    /* Remove the following code if backend fixes this issue: \n     * https://trello.com/c/1IZRihrH/4662-1-forget-call-for-one-stream-id-affects-all-other-streams-with-the-same-symbol\n     * Also remove instrument from function argument list.\n     */\n    //-----Start-----//\n    const instrument = map[key].symbol;\n    const tickSubscribers = map[map.keyFor(instrument, 0)] && map[map.keyFor(instrument, 0)].subscribers;\n    //-----End-----//\n    if (map[key].subscribers === 0 && map[key].id) { /* id is set in stream_handler.js */\n        liveapi.send({ forget: map[key].id })\n            // Remove this part as well.\n            .then(()=>{\n                // Resubscribe to tick stream if there are any tickSubscribers.\n                if(tickSubscribers)\n                    map.register({\n                        symbol: instrument,\n                        granularity: 0,\n                        subscribe: 1,\n                        count: 50 // To avoid missing any ticks.\n                    });\n            })\n            .catch((err) => { console.error(err); });\n    }\n    if (map[key].subscribers === 0) {\n        delete map[key];\n    }\n}\n\n/* this will be use for charts.drawCharts method which wants to : Just make sure that everything has been cleared out before starting a new thread! */\nexport const removeChart = function(key, containerIDWithHash) {\n    const map = this;\n    if (!map[key]) return;\n    if (_(map[key].chartIDs).map('containerIDWithHash').includes(containerIDWithHash)) {\n        map[key].subscribers -= 1;\n        _.remove(map[key].chartIDs, { containerIDWithHash: containerIDWithHash });\n    }\n}\n\nexport const digits_after_decimal = function(pip, symbol) {\n    pip = pip && pip + '';\n    if (!pip) {\n        console.warn();\n        ('pip value is invalid', pip);\n        /**\n         * This is disaster. If pip value is invalid, then it could several trade related issues.\n         * Try to guess decimal places from whatever data we have from local database\n         * (This is a fallback method. the execution never come here)\n         * Technique -\n         *      Fetch last 10 tick values\n         *      Take the maximum decimal places all these ticks\n         */\n        const key = this.keyFor(symbol, 0);\n        let decimal_digits = 0;\n        barsTable.chain()\n            .find({ instrumentCdAndTp: key })\n            .simplesort(\"time\", true).limit(10).data()\n            .forEach((d) => {\n                const quote = d.close + '';\n                const len = quote.substring(quote.indexOf('.') + 1).length;\n                if (len > decimal_digits)\n                    decimal_digits = len;\n            });\n        return decimal_digits;\n    }\n    return pip.substring(pip.indexOf(\".\") + 1).length;\n}\n\nexport default {\n    barsLoaded,\n    processOHLC,\n    keyFor,\n    barsTable,\n    register,\n    subscribe,\n    unregister,\n    removeChart,\n    digits_after_decimal\n}\n"]}