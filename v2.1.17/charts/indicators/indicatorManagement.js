define(["exports","websockets/binary_websockets","common/rivetsExtra","lodash","text!charts/indicators/indicatorManagement.html","text!charts/indicators/indicators.json","charts/indicators/indicatorBuilder","windows/windows","css!charts/indicators/indicatorManagement.css"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.openDialog=void 0;var j=(i(b),i(c)),k=i(d),l=i(e),m=i(f),n=i(g),o=i(h),p=null,q=null,r={};j["default"].formatters["indicators-filter"]=function(a,b,c){return c=c&&c.toLowerCase(),a&&a.filter(function(a){return-1!==a.category.indexOf(b)&&(-1!==a.long_display_name.toLowerCase().indexOf(c)||-1!==a.id.toLowerCase().indexOf(c))}).sort(function(a,b){return a.long_display_name<b.long_display_name?-1:a.long_display_name>b.long_display_name?1:0})},j["default"].formatters["indicators-favorites-filter"]=function(a,b){return b=b&&b.toLowerCase(),a&&a.filter(function(a){return-1!==a.long_display_name.toLowerCase().indexOf(b)||-1!==a.id.toLowerCase().indexOf(b)}).sort(function(a,b){return a.long_display_name<b.long_display_name?-1:a.long_display_name>b.long_display_name?1:0})},j["default"].formatters["indicators-categories"]=function(a,b){b=b&&b.toLowerCase();var c=a&&a.filter(function(a){return-1!==a.long_display_name.toLowerCase().indexOf(b)||-1!==a.id.toLowerCase().indexOf(b)});return c&&k["default"](c).map("category").flatten().uniq().value()};var s=function(){return p?Promise.resolve():new Promise(function(a){t(l["default"]).then(a)})},t=function(a){return new Promise(function(b){a=$(a).i18n();var c={title:"Add/remove indicators".i18n(),modal:!0,destroy:function(){q&&q.unbind(),q=null,p.dialog("destroy").remove(),p=null},open:function(){}};c=isAffiliates()?k["default"].extend(c,{resizable:!1,width:Math.min(480,$(window).width()-10),height:400,ignoreTileAction:!0,maximizable:!1,minimizable:!1,collapsable:!1}):k["default"].extend(c,{width:700}),p=o["default"].createBlankWindow(a,c),u(a),b()})},u=function(a){r={dialog:{title:"Add/remove indicators".i18n(),container_id:"",is_tick_chart:!1},indicators:{search:"",array:[],current:[],favorites:[]}},r.indicators.clear_search=function(){r.indicators.search=""},r.indicators.add=function(a){if(a.fields){var b=JSON.parse(JSON.stringify(a));n["default"].open(b,r.dialog.container_id)}else{var c=a.id;require(["charts/indicators/"+c+"/"+c],function(a){a.open(r.dialog.container_id)})}p.dialog("close")},r.indicators.edit=function(a){if(a.fields){var b=JSON.parse(JSON.stringify(a));n["default"].open(b,r.dialog.container_id,function(){r.indicators.remove(a)})}else{var c=a.id;require(["charts/indicators/"+c+"/"+c],function(b){b.open(r.dialog.container_id,function(){r.indicators.remove(a)})})}p.dialog("close")},r.indicators.remove=function(a){var b=r.indicators.current.indexOf(a);-1!==b&&r.indicators.current.splice(b,1);var c=$(r.dialog.container_id).highcharts();c.series.forEach(function(b){b.options.isInstrument&&b.removeIndicator(a.series_ids)})},r.indicators.favorite=function(a){if(a.is_favorite){a.is_favorite=!1;var b=r.indicators.favorites.indexOf(a);r.indicators.favorites.splice(b,1)}else a.is_favorite=!0,r.indicators.favorites.push(a);var c=r.indicators.favorites.map(function(a){return a.id});local_storage.set("indicator-management-favorite-ids",JSON.stringify(c))},q=j["default"].bind(a[0],r)},v=function(a){var b=JSON.parse(m["default"]),c=local_storage.get("indicator-management-favorite-ids")||[];b=k["default"].filter(b,function(a){return a.is_favorite=-1!==c.indexOf(a.id),!(a.isTickChartNotAllowed&&r.dialog.is_tick_chart)});var d=[];b.forEach(function(b){a.forEach(function(a){a[b.id]&&a[b.id].forEach(function(a){var c=k["default"].cloneDeep(b),e=b.long_display_name!==a.toString();c.name=b.long_display_name,c.shortName=e?a.toString():"",c.showEdit=b.editable,c.series_ids=a.getIDs(),c.current_options=k["default"].cloneDeep(a.options),d.push(c)})})}),r.categories=k["default"](b).map("category").flatten().uniq().value(),r.indicators.favorites=k["default"].filter(b,"is_favorite"),r.indicators.array=b,r.indicators.current=d},w=!0,x=a.openDialog=function(a,b){s().then(function(){r.dialog.title="Add/remove indicators".i18n()+(b?" - "+b:""),r.dialog.container_id=a,r.indicators.current=$(a).data("indicators-current")||[];var c=$(a).data("timePeriod");r.dialog.is_tick_chart=isTick(c);var d=$(a).highcharts().series;d=k["default"].filter(d,"options.isInstrument"),v(d);w||isAffiliates();p.dialog("open"),w=!1})["catch"](void 0)};a["default"]={openDialog:x}});