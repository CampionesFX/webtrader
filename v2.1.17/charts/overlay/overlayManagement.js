define(["exports","../../websockets/binary_websockets","../../common/rivetsExtra","lodash","text!./overlayManagement.html","css!./overlayManagement.css"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.openDialog=void 0;var g=(f(b),f(c)),h=f(d),i=f(e),j=null,k=null,l={};g["default"].formatters["overlays-filter"]=function(a,b){return b=b&&b.toLowerCase(),a&&a.filter(function(a){return-1!==a.display_name.toLowerCase().indexOf(b)})};var m=function(){return j?Promise.resolve():n(i["default"])},n=function(a){return new Promise(function(b){a=$(a).i18n();var c={title:"Add/remove overlays".i18n(),modal:!0,destroy:function(){k&&k.unbind(),k=null,j.dialog("destroy").remove(),j=null},open:function(){}};c=isAffiliates()?h["default"].extend(c,{resizable:!1,width:Math.min(480,$(window).width()-10),height:400,ignoreTileAction:!0,maximizable:!1,minimizable:!1,collapsable:!1}):h["default"].extend(c,{width:700}),require(["windows/windows"],function(d){j=d.createBlankWindow(a,c),o(a),b()})})},o=function(a){l={dialog:{title:"Add/remove overlays".i18n(),container_id:""},overlays:{search:"",array:[],current:[]}},l.overlays.clear_search=function(){l.overlays.search=""},l.overlays.add=function(a){var b=a.symbol,c=a.delay_amount,d=a.display_name,e=l.dialog.container_id,f=($(e).data("timePeriod"),$(e)),g=f.data("type");require(["charts/chartOptions","charts/charts","common/util"],function(f,i){var k=e.replace("#","").replace("_chart",""),m=$(e),n=function(){m.data("overlayIndicator",!0),f.disableEnableCandlestickAndOHLC(k,!1),i.overlay(e,b,d,c).then(function(){var a={symbol:b,displaySymbol:d,delay_amount:c};h["default"].defer(function(){m.trigger("chart-overlay-add",a),i.refresh(e)})})};"candlestick"===g||"ohlc"==g?(m.data("type","line"),m.trigger("chart-type-changed","line"),f.selectChartType(k,"line",!1),h["default"].defer(n)):n(),l.overlays.current.push(d),a.dont_show=!0,j.dialog("close")})},l.overlays.remove=function(a){var b=l.dialog.container_id,c=$(b),d=c.highcharts();if(d&&a){var e=h["default"].find(d.series,function(b){return b.options.name===a&&"navigator"!==b.options.id});if(e){var f=d.get_indicator_series();e.removeCurrentPrice(),e.remove(),h["default"].defer(function(){var a=0;d.series.forEach(function(b){(b.options.isInstrument||b.options.onChartIndicator)&&-1==b.options.id.indexOf("navigator")&&++a}),1==a&&d.series.forEach(function(a){return(a.options.isInstrument||a.options.onChartIndicator)&&-1==a.options.id.indexOf("navigator")?(a.update({compare:void 0}),$(b).data("overlayIndicator",null),require(["charts/chartOptions"],function(a){var c=b.replace("#","").replace("_chart","");a.disableEnableCandlestickAndOHLC(c,!0)}),h["default"].defer(function(){require(["charts/charts"],function(a){a.refresh(b)})}),!1):void 0}),d.set_indicator_series(f)})}var g=!1;l.overlays.array.forEach(function(b){return b.submarkets.forEach(function(b){return b.instruments.forEach(function(b){return b.display_name===a&&(b.dont_show=!1,g=!0),!g}),!g}),!g}),l.overlays.current.splice(l.overlays.current.indexOf(a),1),c.trigger("chart-overlay-remove",{displaySymbol:a})}},k=g["default"].bind(a[0],l)},p=function(a){require(["instruments/instruments"],function(b){var c=a.series[0].options.name,d=h["default"].filter(a.series,function(a,b){return a.options.isInstrument&&"navigator"!==a.options.id&&0!==b}).map(function(a){return a.options.name})||[],e=b.getMarketData()||[];e.forEach(function(a){a.submarkets.forEach(function(a){a.instruments.forEach(function(a){a.dont_show=h["default"].includes(d,a.display_name)||c===a.display_name?!0:!1})})}),l.overlays.array=e,l.overlays.current=d})},q=!0,r=a.openDialog=function(a,b){m().then(function(){l.dialog.title="Add/remove comparisons".i18n()+(b?" - "+b:""),l.dialog.container_id=a,l.overlays.current=$(a).data("overlays-current")||[];var c=$(a).highcharts();p(c);q||isAffiliates();j.dialog("open"),q=!1})["catch"](void 0)};a["default"]={openDialog:r}});