define(["exports","jquery","common/rivetsExtra","lodash","charts/chartWindow","charts/charts","moment","charts/chartingRequestMap","text!charts/chartOptions.html","charts/indicators/indicatorManagement","charts/overlay/overlayManagement","charts/crosshair","charts/chartTemplateManager","css!charts/chartOptions.css","common/util"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";function n(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.getAllChartsWithTheirTypes=a.setIndicatorsCount=a.cleanBinding=a.selectChartType=a.disableEnableCandlestickAndOHLC=a.updateOptions=a.init=void 0;var o=n(b),p=n(c),q=n(d),r=(n(e),n(f)),s=(n(g),n(h),n(i)),t=n(j),u=n(k),v=n(l),w=n(m),x=[],y=[],z={},A={},B=!1,C=[{value:"1t",name:"1 Tick",digit:1,type:"ticks"},{value:"1m",name:"1 Minute",digit:1,type:"minutes"},{value:"2m",name:"2 Minutes",digit:2,type:"minutes"},{value:"3m",name:"3 Minutes",digit:3,type:"minutes"},{value:"5m",name:"5 Minutes",digit:5,type:"minutes"},{value:"10m",name:"10 Minutes",digit:10,type:"minutes"},{value:"15m",name:"15 Minutes",digit:15,type:"minutes"},{value:"30m",name:"30 Minutes",digit:30,type:"minutes"},{value:"1h",name:"1 Hour",digit:1,type:"hours"},{value:"2h",name:"2 Hours",digit:2,type:"hours"},{value:"4h",name:"4 Hours",digit:4,type:"hours"},{value:"8h",name:"8 Hours",digit:8,type:"hours"},{value:"1d",name:"1 Day",digit:1,type:"days"}],D=[{value:"candlestick",name:"Candles"},{value:"ohlc",name:"OHLC"},{value:"line",name:"Line"},{value:"dot",name:"Dot"},{value:"linedot",name:"Line Dot"},{value:"spline",name:"Spline"},{value:"table",name:"Table"}],E=(local_storage.get("i18n")||{value:"en"}).value,F=getAppURL(),G=F+"?affiliates=true&instrument={0}&timePeriod={1}&lang="+E,H='<iframe src="'+G+'" width="350" height="400" style="overflow-y : hidden;" scrolling="no" />',I="https://twitter.com/share?url={0}&text={1}",J="https://facebook.com/sharer/sharer.php?u={0}",K="https://plus.google.com/share?url={0}",L="https://www.blogger.com/blog-this.g?u={0}&n={1}",M="http://vk.com/share.php?url={0}&title={1}",N=function(a){a.showTimePeriodSelector=!1,a.toggleLoadSaveSelector(null,a),a.toggleChartTypeSelector(null,a),a.toggleDrawingToolSelector(null,a),a.toggleExportSelector(null,a)},O=function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;"table"==b?(x[a.newTabId].showChartTypeSelector=!1,a.tableViewCallback&&a.tableViewCallback()):(x[a.newTabId].chartType=D.filter(function(a){return a.value==b})[0],x[a.newTabId].showChartTypeSelector=!1,r["default"].refresh("#"+a.newTabId+"_chart",c,b),o["default"]("#"+a.newTabId).trigger("chart-type-changed",b)),N(a)},P=function(a){var b=!1,c=o["default"](a).highcharts();return c&&c.series.forEach(function(a){"percent"===a.options.compare&&(b=!0)}),b},Q=function(a,b){b?(x[a].chartTypes=D,x[a].chartTypes[1].showBorder=!0):x[a].chartTypes=D.filter(function(a){return"candlestick"!==a.value&&"ohlc"!==a.value})},R=function(a,b){var c=b.find(".loadSaveOverlay"),d=b.find(".exportOverlay"),e=b.find(".timeperiod"),f=b.find(".chart_type");b.find(".chartTypeOverlay").css("width",A.ct+53+"px");var g=b.find(".shareButton"),h=420+(A.tp.max+A.ct+65-184);isAffiliates()&&(o["default"](window).width()>h+A.inst?(o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("margin","5px 0px"),o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("float","left"),o["default"]("#"+a.newTabId+" .chartOptions .instrument_name"),a.showInstrumentName=!0,o["default"]("#"+a.newTabId+"_chart").highcharts().setTitle({text:""})):(o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("margin","5px auto"),o["default"](o["default"]("#"+a.newTabId+" .chartOptions .table")[0]).css("float",""),a.showInstrumentName=!1,o["default"]("#"+a.newTabId+"_chart").highcharts().setTitle({text:a.instrumentName}))),b.width()>h?(a.showChartTypeLabel=!0,a.timePeriod_name=a.timePeriod.name,e.css("width",A.tp.max+25+"px"),f.css("width",A.ct+55+"px")):(a.showChartTypeLabel=!1,a.timePeriod_name="en"==E?a.timePeriod.value.toUpperCase():a.timePeriod.value.i18n(),e.css("width",A.tp.min+27+"px"),f.css("width","45px"));var i=b.width()-(g.offset().left+g.outerWidth()-b.offset().left);b.width()<=730?(i=i>0?i:25,d.css("right",i+"px"),c.css("right",i+35+"px")):(c.css("right","auto"),d.css("right","auto"))},S=function(a){var b=C.reduce(function(a,b){return a.value.i18n().length>b.value.i18n().length?a:b}),c=C.reduce(function(a,b){return a.name.i18n().length>b.name.i18n().length?a:b}),d=D.reduce(function(a,b){return a.name.i18n().length>b.name.i18n().length?a:b}),e=function(a){var b="0.8em roboto,sans-serif",c=o["default"]("<div>"+a.i18n()+"</div>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden",font:b}).appendTo(o["default"]("body")),d=c.width();return c.remove(),d};A.tp={},A.tp.min=e(b.value),A.tp.max=e(c.name),A.ct=e(d.name),A.inst=e(a)+20},T=function(a,b){a=o["default"](a);var c=a.attr("class");a.toggleClass(c);var d=c.split("-")[0];c=b===!0?d+"-w-icon":d+"-icon",a.toggleClass(c)},U=a.init=function(a,b,c,d,e,f,g,h){S(e),y[a]&&y[a].unbind(),x[a]={newTabId:a,timePeriod:C.filter(function(a){return b==a.value})[0],timeperiod_arr:C,chartType:D.filter(function(a){return a.value==c})[0],tableViewCallback:d,instrumentName:e,instrumentCode:f,indicatorsCount:0,overlayCount:0,showTimePeriodSelector:!1,showChartTypeSelector:!1,showTableOption:!0,enableCrosshair:!0,showDrawingToolSelector:!1,showExportSelector:!1,showLoadSaveSelector:!1,showShare:"undefined"==typeof g?!0:g,showOverlay:"undefined"==typeof h?!0:h,showInstrumentName:!1,exportChartURLShare:G.format(f,b),exportChartIframeShare:H.format(f,b),fbShareLink:J.format(encodeURIComponent(G.format(f,b))),twitterShareLink:I.format(encodeURIComponent(G.format(f,b)),e+"("+b+")"),gPlusShareLink:K.format(encodeURIComponent(G.format(f,b))),bloggerShareLink:L.format(G.format(f,b),e+"("+b+")"),vkShareLink:M.format(G.format(f,b),e+"("+b+")")},y[a]=null,x[a].toggleTimerPeriodSelector=function(a,b){var c=!b.showTimePeriodSelector;N(b),b.showTimePeriodSelector=c,a.originalEvent.scope=b.newTabId},x[a].toggleChartTypeSelector=function(a,b){var c=!b.showChartTypeSelector,d=o["default"]("#"+b.newTabId+" .chart_type .img span")[0];1==c&&a?(N(b),b.showChartTypeSelector=c,T(d,!0),a.originalEvent.scope=b.newTabId):(b.showChartTypeSelector=!1,T(d,!1))},x[a].addRemoveIndicator=function(a,b){var c=b.instrumentName+" ("+b.timePeriod.value+")";t["default"].openDialog("#"+b.newTabId+"_chart",c)},x[a].addRemoveOverlay=function(a,b){var c=b.instrumentName+" ("+b.timePeriod.value+")";u["default"].openDialog("#"+b.newTabId+"_chart",c)},x[a].changeChartType=function(a,b){var c=o["default"](a.target).attr("data-charttype");c&&O(b,c)},x[a].changeTimePeriod=function(c,d){var g=c.target.dataset.timeperiod;if(g){d=x[d.newTabId],d.timePeriod=C.filter(function(a){return g==a.value})[0],R(d,o["default"]("#"+d.newTabId).find(".chart-view"));var h=isTick(g);!h||"candlestick"!==d.chartType.value&&"ohlc"!==d.chartType.value?r["default"].refresh("#"+d.newTabId+"_chart",g,d.chartType.value):O(d,"line",g),Q(d.newTabId,!h&&!P("#"+a+"_chart")),d.exportChartURLShare=G.format(d.instrumentCode,g),d.exportChartIframeShare=H.format(d.instrumentCode,g),d.fbShareLink=J.format(encodeURIComponent(G.format(f,b))),d.twitterShareLink=I.format(encodeURIComponent(G.format(f,b)),e+"("+b+")"),d.gPlusShareLink=K.format(encodeURIComponent(G.format(f,b))),d.bloggerShareLink=L.format(encodeURIComponent(G.format(f,b)),e+"("+b+")"),d.vkShareLink=M.format(encodeURIComponent(G.format(f,b)),e+"("+b+")"),o["default"]("#"+d.newTabId).trigger("chart-time-period-changed",g)}},Q(a,!isTick(b)&&!P("#"+a+"_chart")),d||(x[a].showTableOption=!1),x[a].toggleCrosshair=function(a,b){b.enableCrosshair=!b.enableCrosshair,v["default"].toggleCrossHair("#"+b.newTabId+"_chart")},x[a].toggleDrawingToolSelector=function(a,b){var c=!b.showDrawingToolSelector,d=o["default"]("#"+b.newTabId+" .drawButton .img span")[0];1==c&&a?(N(b),b.showDrawingToolSelector=c,T(d,!0),a.originalEvent.scope=b.newTabId):(b.showDrawingToolSelector=!1,T(d,!1))},x[a].addDrawingTool=function(a,b){var c=a.target.dataset.drawingtool;c&&require(["charts/draw/highcharts_custom/"+c],function(a){var c="#"+b.newTabId+"_chart";o["default"](c).highcharts().annotate=!0,a.init(c)})},x[a].toggleExportSelector=function(a,b){var c=!b.showExportSelector,d=o["default"]("#"+b.newTabId+" .shareButton .img span")[0];1==c&&a?(N(b),b.showExportSelector=c,T(d,!0),a.originalEvent.scope=b.newTabId):(b.showExportSelector=!1,T(d,!1))},x[a].toggleLoadSaveSelector=function(a,b){var c=!b.showLoadSaveSelector,d=o["default"]("#"+b.newTabId+" .templateButton .img span")[0];1==c&&a?(N(b),b.showLoadSaveSelector=c,T(d,!0),a.originalEvent.scope=b.newTabId):(b.showLoadSaveSelector=!1,T(d,!1))},x[a]["export"]=function(a,b){var c=a.target.dataset.exporttype;if(c){var d="#"+b.newTabId+"_chart",e=o["default"](d).highcharts();switch(c){case"png":e.exportChartLocal();break;case"pdf":e.exportChart({type:"application/pdf"});break;case"csv":r["default"].generate_csv(e,o["default"](d).data());break;case"svg":e.exportChartLocal({type:"image/svg+xml"})}}},o["default"]("#"+a).on("chart-indicators-changed",function(b,c){x[a].indicatorsCount=c.get_indicators().length}),x[a].overlayCount=o["default"]("#"+a+"_chart").data("overlayCount"),o["default"]("#"+a).on("chart-overlay-add",function(){var b=o["default"]("#"+a+"_chart").highcharts();x[a].overlayCount=b.get_overlay_count()}),o["default"]("#"+a).on("chart-overlay-remove",function(){var b=o["default"]("#"+a+"_chart").highcharts();x[a].overlayCount=b.get_overlay_count()}),isAffiliates()?o["default"](window).resize(function(){R(x[a],o["default"]("#"+a).find(".chart-view"))}):o["default"]("#"+a).on("resize-event",function(){R(x[a],o["default"](this).find(".chart-view"))}),!B&&o["default"]("body").on("click",function(a){q["default"].forEach(Object.keys(x),function(b){a.originalEvent&&b!=a.originalEvent.scope&&N(x[b])})}),B=!0;var i=o["default"](s["default"]).i18n();o["default"]("#"+a+"_header").prepend(i),p["default"].formatters.filter=function(a,b){return a.filter(function(a){return a.type==b})},y[a]=p["default"].bind(i[0],x[a]);var j=i.find(".chart-template-manager-root");z[a]=w["default"].init(j,a),i.find(".loadSaveOverlay").on("click",function(a){a.stopPropagation()}),i.find(".exportOverlay").on("click",function(a){a.stopPropagation()}),R(x[a],o["default"]("#"+a).find(".chart-view"))},V=a.updateOptions=function(a,b,c,d,e){var f=x[a];f&&(f.chartType=D.filter(function(a){return a.value==b})[0],f.timePeriod=C.filter(function(a){return c==a.value})[0],f.indicatorsCount=d,f.overlayCount=e,Q(a,!isTick(c)&&e>0),R(f,o["default"]("#"+a).find(".chart-view")))},W=a.disableEnableCandlestickAndOHLC=function(a,b){x[a]&&Q(a,b)},X=a.selectChartType=function(a,b,c){c?x[a].changeChartType(x[a],b):x[a].chartType=D.filter(function(a){return a.value==b})[0]},Y=a.cleanBinding=function(a){y[a]&&(y[a].unbind(),z[a]&&z[a].unbind(),delete z[a],delete y[a],delete x[a])},Z=a.setIndicatorsCount=function(a,b){x[b].indicatorsCount=a},$=a.getAllChartsWithTheirTypes=function(){return q["default"].keys(x).map(function(a){return{id:a,chartType:x[a].chartType.value}})};a["default"]={init:U,updateOptions:V,disableEnableCandlestickAndOHLC:W,selectChartType:X,cleanBinding:Y,setIndicatorsCount:Z,getAllChartsWithTheirTypes:$}});