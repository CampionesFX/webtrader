{"version":3,"sources":["../../../../src/charts/tableView.es6"],"names":["barsTable","show_table_view","dialog","instrumentCode","offset","table","find","chart","css","animate","left","refresh_table","tbl","DataTable","columns","adjust","draw","view_table_visible","hide_table_view","getColumns","is_tick","title","orderable","render","epoch","utc","utcOffset","format","columnIndexes","data","attr","isTick","timePeriod","bars","chain","instrumentCdAndTp","keyFor","simplesort","limit","index","rows","map","bar","preBar","length","diff","calculatePercentageDiff","open","time","value","image","close","high","low","api","remove","destroy","__ret","dataTable","paging","ordering","info","order","columnDefs","className","parent","addClass","add","firstNumber","secondNumber","toFixed","Math","abs","Percentage_diff","init","container","on","bind","appendTo","on_tick","events","d","key","tick","preTick","row","on_ohlc","ohlc","preOhlc","is_new","topRowIndex","off","show","hide"],"mappings":"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","file":"tableView.js","sourcesContent":["/**\n * Created by amin january 21, 2016.\n */\n\nimport $ from 'jquery';\nimport moment from 'moment';\nimport loki from 'lokijs';\nimport chartingRequestMap from './chartingRequestMap';\nimport stream_handler from '../websockets/stream_handler';\nimport 'datatables';\n\nconst barsTable = chartingRequestMap.barsTable;\n\nconst show_table_view = (dialog, instrumentCode, offset) => {\n   const table = dialog.find('.table-view');\n   const chart = dialog.find('.chart-view');\n   dialog.find('span.close').css('display', 'block');\n   table.animate({left: '0'}, 250);\n   chart.animate({left: '-100%'}, 250);\n   refresh_table(dialog, instrumentCode, offset);\n   /* clear table and fill it again */\n   //Adjust table column size\n   const tbl = table.find('table').DataTable();\n   tbl.columns.adjust().draw();\n   dialog.view_table_visible = true;\n   /* let stream_handler new ohlc or ticks update the table */\n}\n\nconst hide_table_view = (dialog) => {\n   const table = dialog.find('.table-view');\n   const chart = dialog.find('.chart-view');\n   dialog.find('span.close').css('display', 'none');\n   table.animate({left: '100%'}, 250);\n   chart.animate({left: '0'}, 250);\n   dialog.view_table_visible = false;\n}\n\nconst getColumns = (is_tick, offset) => {\n   let columns = [\n      {\n         title: 'Date', orderable: false,\n         render: (epoch) => moment.utc(epoch).utcOffset(offset).format('YYYY-MM-DD HH:mm:ss')\n      },\n      {title: 'Open', orderable: false,},\n      {title: 'High', orderable: false,},\n      {title: 'Low', orderable: false,},\n      {title: 'Close', orderable: false,},\n      {title: 'Change', orderable: false,},\n      {title: '', orderable: false,}\n   ];\n   let columnIndexes = [0, 1, 2, 3, 4, 5];\n   if (is_tick) { /* for tick charts only show Date,Tick */\n      columns = [\n         {\n            title: 'Date', orderable: false,\n            render: (epoch) => moment.utc(epoch).utcOffset(offset).format('YYYY-MM-DD HH:mm:ss')\n         },\n         {title: 'Tick', orderable: false,},\n         {title: 'Change', orderable: false,},\n         {title: '', orderable: false,}\n      ];\n      columnIndexes = [0, 1, 2];\n   }\n   return {columns: columns, columnIndexes: columnIndexes};\n}\n\nconst refresh_table = (dialog, instrumentCode, offset) => {\n   const data = dialog.find('#' + dialog.attr('id') + '_chart').data();\n   const is_tick = isTick(data.timePeriod);\n   const table = dialog.find('.table-view');\n   const bars = barsTable\n      .chain()\n      .find({instrumentCdAndTp: chartingRequestMap.keyFor(instrumentCode, data.timePeriod)})\n      .simplesort('time', true)\n      .limit(100)\n      .data();\n   let index = 0;\n   const rows = bars.map((bar) => {\n      //The bars list has been sotrted by time ,The previous value is in next index\n      const preBar = index == bars.length - 1 ? bars[index] : bars[index + 1];\n      index++;\n      if (is_tick) {\n         const diff = calculatePercentageDiff(preBar.open, bar.open);\n         return [bar.time, bar.open, diff.value, diff.image];\n      }\n      const diff = calculatePercentageDiff(preBar.close, bar.close);\n      return [\n         bar.time,\n         bar.open,\n         bar.high,\n         bar.low,\n         bar.close,\n         diff.value,\n         diff.image\n      ];\n   });\n   let api = table.find('table').DataTable();\n   api.rows().remove();\n   api.destroy();\n   table.find('table *').remove();\n   const __ret = getColumns(is_tick, offset);\n   table.find('table').dataTable({\n      data: [],\n      columns: __ret.columns,\n      paging: false,\n      ordering: true,\n      info: false,\n      order: [0, 'desc'],\n      columnDefs: [{className: \"dt-head-center dt-body-center\", \"targets\": __ret.columnIndexes}]\n   }).parent().addClass('hide-search-input');\n   api = table.find('table').DataTable();\n\n   api.rows.add(rows);\n   api.draw();\n};\n\nconst calculatePercentageDiff = (firstNumber, secondNumber) => {\n   /*Calculation = ( | V1 - V2 | / |V1| )* 100 */\n   const diff = toFixed(Math.abs(firstNumber - secondNumber), 4);\n   const Percentage_diff = toFixed((Math.abs(firstNumber - secondNumber) / Math.abs(firstNumber)) * 100, 2);\n   if (firstNumber <= secondNumber)\n      return {\n         value: diff + '(' + Percentage_diff + '%)',\n         image: diff === 0 ? '' : '<img src=\"images/blue_up_arrow.svg\" class=\"arrow-images\"/>'\n      };\n   else\n      return {\n         value: '<span style=\"color:brown\">' + diff + '(' + Percentage_diff + '%) </span>',\n         image: diff === 0 ? '' : '<img src=\"images/orange_down_arrow.svg\" class=\"arrow-images\"/>'\n      };\n};\n\nexport const init = (dialog, offset) => {\n   offset = offset ? offset *(-1) : 0;\n   const container = dialog.find('.table-view');\n   const data = dialog.find('#' + dialog.attr('id') + '_chart').data();\n   const is_tick = isTick(data.timePeriod);\n   const close = dialog.find('span.close');\n   close.on('click', hide_table_view.bind(null, dialog));\n   /* hide the dialog on close icon click */\n\n   let table = $(\"<table class='portfolio-dialog hover'/>\");\n   table.appendTo(container);\n\n   const __ret = getColumns(is_tick, offset);\n   table = table.dataTable({\n      data: [],\n      columns: __ret.columns,\n      paging: false,\n      ordering: true,\n      info: false,\n      order: [0, 'desc'],\n      columnDefs: [{className: \"dt-head-center dt-body-center\", \"targets\": __ret.columnIndexes}]\n   });\n   table.parent().addClass('hide-search-input');\n\n   const on_tick = stream_handler.events.on('tick', (d) => {\n      if (d.key !== chartingRequestMap.keyFor(data.instrumentCode, data.timePeriod)) return;\n      if (!dialog.view_table_visible) return;\n      const tick = d.tick;\n      const diff = calculatePercentageDiff(d.preTick.open, tick.open);\n      const row = [tick.time, tick.open, diff.value, diff.image];\n      table.api().row.add(row);\n      table.api().draw();\n   });\n\n   const on_ohlc = stream_handler.events.on('ohlc', (d) => {\n      if (d.key !== chartingRequestMap.keyFor(data.instrumentCode, data.timePeriod)) return;\n      if (!dialog.view_table_visible) return;\n      const ohlc = d.ohlc;\n      const diff = calculatePercentageDiff(d.preOhlc.close, ohlc.close);\n      const row = [\n         ohlc.time,\n         ohlc.open,\n         ohlc.high,\n         ohlc.low,\n         ohlc.close,\n         diff.value,\n         diff.image\n      ];\n      if (d.is_new) {\n         table.api().row.add(row);\n      }\n      else {\n         const topRowIndex = table.api().rows()[0][0];\n         table.api().row(topRowIndex).data(row);\n      }\n      table.api().draw();\n   });\n\n   dialog.on('dialogdestroy', () => {\n      stream_handler.events.off('tick', on_tick);\n      stream_handler.events.off('ohlc', on_ohlc);\n   });\n\n   return {\n      show: show_table_view.bind(null, dialog, data.instrumentCode, offset),\n      hide: hide_table_view.bind(null, dialog)\n   }\n}\n\nexport default { init };\n"]}