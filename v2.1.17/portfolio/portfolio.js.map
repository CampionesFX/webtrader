{"version":3,"sources":["../../../../src/portfolio/portfolio.es6"],"names":["portfolioWin","table","balance_span","currency","subscribed_contracts","init","li","click","initPortfolioWin","moveToTop","update_indicative","data","contract","proposal_open_contract","id","contract_id","bid_price","row","api","cols","perv_indicative","tr","find","is_valid_to_sell","removeClass","addClass","subscribed_before","subscribers","events","on","proposalOpenContract","command","send","subscribe","then","catch","err","console","error","growl","message","forget_all","on_arrow_click","e","target","$target","tagName","hasClass","parentElement","transaction","_","last","require","viewTransaction","transaction_id","balance","undefined","update","action","view_button","i18n","longcode","Math","abs","amount","rows","add","draw","subscribe_to_contracts","remove","forget_the_contracts","createBlankWindow","title","width","height","close","off","open","init_table","destroy","DataTable","refresh","header","parent","insertAfter","html","formatPrice","appendTo","dataTable","columns","render","val","rowId","paging","ordering","processing","track","module_id","is_unique","dialog","contracts","forEach","push","promises","map","forget","ids","filter","includes","Promise","all","processing_msg","attr","show","portfolio","buy_price","sell_expired","expiry_time","hide","resubscribe"],"mappings":"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","file":"portfolio.js","sourcesContent":["ï»¿/**\n * Created by amin on 10/9/15.\n */\n\nimport $ from 'jquery';\nimport windows from '../windows/windows';\nimport liveapi from '../websockets/binary_websockets';\nimport 'jquery-ui';\nimport 'datatables';\nimport 'jquery-growl';\n\nvar portfolioWin = null;\nvar table = null;\nvar balance_span = null;\nvar currency = 'USD';\nvar subscribed_contracts = [];\n\nexport const init = (li) => {\n    li.click(function () {\n        if(!portfolioWin)\n            initPortfolioWin();\n        else\n            portfolioWin.moveToTop();\n    });\n}\n\nconst update_indicative = (data) => {\n    var contract = data.proposal_open_contract;\n    var id = contract.contract_id,\n        bid_price = contract.bid_price;\n\n    if (table) {\n        var row = table.api().row('#' + id);\n        var cols = row.data();\n        if(!cols)\n            return; /* table might be empty */\n        var perv_indicative = cols[3];\n        cols[3] = bid_price; /* update the indicative column */\n        row.data(cols);\n\n        /* colorize indicative column on change */\n        var tr = table.find('#' + id);\n        if(!contract.is_valid_to_sell) {\n            tr.removeClass('indicative-red indicative-green').addClass('resale-not-offered');\n        } else {\n            tr.removeClass('resale-not-offered');\n            if(perv_indicative !== bid_price) {\n            tr.removeClass('indicative-red indicative-green')\n                .addClass((perv_indicative*1 < bid_price*1) ? 'indicative-green' : 'indicative-red');\n            }\n        }\n    }\n}\n\nvar subscribed_before = false;\nvar subscribers = 0;\nliveapi.events.on('logout', function(){\n    subscribed_before = false;\n    subscribers = 0;\n});\n\n/* command could be 'subscribe','forget' and 'resubscribe'. */\nconst proposalOpenContract = (command) => {\n    if(command === 'subscribe') {\n        ++subscribers;\n        if(!subscribed_before && subscribers > 0) {\n            liveapi.send({ proposal_open_contract: 1,subscribe: 1 })\n                .then(function(data){ subscribed_before = true; })\n                .catch(function (err) {\n                    console.error(err);\n                    $.growl.error({ message: err.message });\n                });\n        }\n    }\n    else if(command === 'forget') {\n        --subscribers;\n        if(subscribed_before && subscribers === 0) {\n            liveapi.send({ forget_all: 'proposal_open_contract' })\n                .then(function(data){\n                    subscribed_before = false;\n                })\n                .catch(function (err) {\n                    subscribed_before = false;\n                    console.error(err.message);\n                });\n        }\n    }\n    else if( command === 'resubscribe' ) {\n        liveapi.send({ forget_all: 'proposal_open_contract' })\n            .then(function(data) {\n                subscribed_before = false;\n                --subscribers;\n                proposalOpenContract('subscribe'); /* subscribe again */\n            })\n            .catch(function (err) {\n                subscribed_before = false;\n                console.error(err.message);\n            });\n    }\n    else {\n        console.error('wrong command!');\n        return;\n    }\n}\n\nvar on_arrow_click = function(e){\n    var target = e.target;\n    var $target = $(target);\n    if(target.tagName !== 'BUTTON' || $target.hasClass('button-disabled'))\n    return;\n    var tr = target.parentElement.parentElement;\n    var transaction = table.api().row(tr).data();\n    transaction = _.last(transaction);\n    $target.addClass('button-disabled');\n    require(['viewtransaction/viewTransaction'], function(viewTransaction){\n    viewTransaction.init(transaction.contract_id, transaction.transaction_id)\n                    .then(function(){ $target.removeClass('button-disabled'); });\n    });\n}\n\nfunction initPortfolioWin() {\n    require(['css!portfolio/portfolio.css']);\n    /* refresh blance on blance change */\n    liveapi.events.on('balance',function(data){\n        if(data.balance !== undefined && data.balance.currency !== undefined) {\n        currency = data.balance.currency;\n        balance_span.update(data.balance.balance);\n        }\n    });\n    /* refresh portfolio when a new contract is added or closed */\n    liveapi.events.on('transaction', function(data){\n        var transaction = data.transaction;\n\n        if(transaction.action === 'buy') {\n            var view_button = '<button>View</button>'.i18n();\n            var row = [\n                transaction.transaction_id,\n                transaction.longcode,\n                Math.abs(transaction.amount),\n                '0.00',\n                view_button,\n                transaction.contract_id, /* for jq-datatables rowId */\n                transaction, /* data for view transaction dailog - when clicking on arrows */\n            ];\n            table.api().rows.add([row]);\n            table.api().draw();\n            subscribe_to_contracts([transaction]);\n        } else if (transaction.action === 'sell') {\n            var tr = table.find('#' + transaction.contract_id)[0];\n            table.api().row(tr).remove();\n            table.api().draw();\n            forget_the_contracts([transaction]);\n        }\n    });\n\n    liveapi.send({ balance: 1 })\n        .then(function (data) {\n\n            portfolioWin = windows.createBlankWindow($('<div/>'), {\n                title: 'Portfolio'.i18n(),\n                width: 700 ,\n                height: 400,\n                'data-authorized': 'true',\n                close: function () {\n                    forget_the_contracts(subscribed_contracts);\n                    /* un-register proposal_open_contract handler */\n                    liveapi.events.off('proposal_open_contract', update_indicative);\n                },\n                open: function () {\n                    init_table();\n                    /* register handler for proposal_open_contract */\n                    liveapi.events.on('proposal_open_contract', update_indicative);\n                },\n                destroy: function() {\n                    table && table.DataTable().destroy(true);\n                    portfolioWin = null;\n                },\n                refresh: function() {\n                    liveapi.send({ balance: 1 }).catch(function (err) { console.error(err); $.growl.error({ message: err.message }); });\n                    forget_the_contracts(subscribed_contracts).then(init_table);\n                }\n            });\n\n            var header = portfolioWin.parent().find('.ui-dialog-title').addClass('with-content');\n            balance_span = $('<span class=\"span-in-dialog-header\" />')\n                .insertAfter(header);\n            balance_span.update = function(balance) {\n                balance_span.html('Account balance: <strong>'.i18n() +  formatPrice(balance, currency) + '</strong>');\n            };\n\n            var currency = data.balance.currency;\n            table = $(\"<table width='100%' class='portfolio-dialog hover'/>\");\n            table.appendTo(portfolioWin);\n            table = table.dataTable({\n                data: [],\n                columns: [\n                    { title: 'Ref.'.i18n() },\n                    { title: 'Contract Details'.i18n() },\n                    {\n                        title: 'Purchase'.i18n(),\n                        render: function(val) { return '<span class=\"bold\">' + formatPrice(val,currency) + '</span>'; }\n                    },\n                    {\n                        title: 'Indicative'.i18n(),\n                        render: function(val) { return '<span class=\"bold\">' + formatPrice(val,currency) + '</span>'; }\n                    },\n                    { title: '' }\n                ],\n                rowId : '5', /* jQ datatables support selecting rows based on rowId https://datatables.net/reference/type/row-selector\n                                we want not to query rows everytime we update the indicative column */\n                paging: false,\n                ordering: false,\n                processing: true\n            });\n            table.parent().addClass('hide-search-input');\n\n            portfolioWin.on('click', on_arrow_click);\n            portfolioWin.track({\n                module_id: 'portfolio',\n                is_unique: true,\n                data: null\n            });\n            portfolioWin.dialog('open');\n        })\n        .catch(function (err) {\n            console.error(err);\n        });\n\n}\n\nfunction subscribe_to_contracts(contracts) {\n    contracts.forEach(function(contract){\n        subscribed_contracts.push(contract);\n        liveapi.proposal_open_contract\n            .subscribe(contract.contract_id)\n            .catch(function(err) {\n                $.growl.error({ message: err.message });\n            });\n    });\n}\n\nfunction forget_the_contracts(contracts) {\n    var promises = contracts.map(function(contract){\n        return liveapi.proposal_open_contract\n                .forget(contract.contract_id)\n                .catch(function(err) {\n                $.growl.error({ message: err.message });\n                });\n    });\n    var ids = _.map(contracts, 'contract_id');\n    subscribed_contracts = subscribed_contracts.filter(function(contract) {\n        return _.includes(ids, contract.contract_id) === false;\n    });\n    return Promise.all(promises);\n}\n\nasync function init_table(){\n    var processing_msg = $('#' + table.attr('id') + '_processing').show();\n    try {\n        const data = await liveapi.send({ portfolio: 1 });\n        var contracts = (data.portfolio && data.portfolio.contracts);\n            //|| [\n            //    {\n            //        symbol: '', shortcode: '', contract_id: '', longcode: '', expiry_time: 0, currency: '',\n            //        date_start: 0, purchase_time: 0, buy_price: '', contract_type: '', payout: ''\n            //    }\n            //];\n\n        var view_button = '<button>View</button>'.i18n();\n        var rows = contracts.map(function (contract) {\n            return [\n                contract.transaction_id,\n                contract.longcode,\n                contract.buy_price,\n                '0.00',\n                view_button,\n                contract.contract_id, /* for jq-datatables rowId */\n                contract, /* data for view transaction dailog - when clicking on arrows */\n            ];\n        });\n        /* register callback to sell contract on expiration */\n        contracts.forEach(contract => liveapi.sell_expired(contract.expiry_time));\n        subscribe_to_contracts(contracts);\n\n        /* update the table */\n        table.api().rows().remove();\n        table.api().rows.add(rows);\n        table.api().draw();\n        processing_msg.hide();\n    }\n    catch(err) {\n        console.error(err);\n        table.api().rows().remove();\n        table.api().draw();\n        processing_msg.hide();\n        $.growl.error({ message: err.message });\n    }\n}\n\nexport const proposal_open_contract = {\n    subscribe: function () { proposalOpenContract('subscribe'); },\n    forget: function () { proposalOpenContract('forget'); },\n    resubscribe: function () { proposalOpenContract('resubscribe'); }\n};\n\nexport default { init, proposal_open_contract }; "]}