define(["exports","babel-runtime/regenerator","jquery","../windows/windows","../websockets/binary_websockets","jquery-ui","datatables","jquery-growl"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}function g(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(i){return void c(i)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}function h(){require(["css!portfolio/portfolio.css"]),n["default"].events.on("balance",function(a){void 0!==a.balance&&void 0!==a.balance.currency&&(r=a.balance.currency,q.update(a.balance.balance))}),n["default"].events.on("transaction",function(a){var b=a.transaction;if("buy"===b.action){var c="<button>View</button>".i18n(),d=[b.transaction_id,b.longcode,Math.abs(b.amount),"0.00",c,b.contract_id,b];p.api().rows.add([d]),p.api().draw(),i([b])}else if("sell"===b.action){var e=p.find("#"+b.contract_id)[0];p.api().row(e).remove(),p.api().draw(),j([b])}}),n["default"].send({balance:1}).then(function(a){o=m["default"].createBlankWindow(l["default"]("<div/>"),{title:"Portfolio".i18n(),width:700,height:400,"data-authorized":"true",close:function(){j(s),n["default"].events.off("proposal_open_contract",u)},open:function(){z(),n["default"].events.on("proposal_open_contract",u)},destroy:function(){p&&p.DataTable().destroy(!0),o=null},refresh:function(){n["default"].send({balance:1})["catch"](function(a){l["default"].growl.error({message:a.message})}),j(s).then(z)}});var b=o.parent().find(".ui-dialog-title").addClass("with-content");q=l["default"]('<span class="span-in-dialog-header" />').insertAfter(b),q.update=function(a){q.html("Account balance: <strong>".i18n()+formatPrice(a,c)+"</strong>")};var c=a.balance.currency;p=l["default"]("<table width='100%' class='portfolio-dialog hover'/>"),p.appendTo(o),p=p.dataTable({data:[],columns:[{title:"Ref.".i18n()},{title:"Contract Details".i18n()},{title:"Purchase".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,c)+"</span>"}},{title:"Indicative".i18n(),render:function(a){return'<span class="bold">'+formatPrice(a,c)+"</span>"}},{title:""}],rowId:"5",paging:!1,ordering:!1,processing:!0}),p.parent().addClass("hide-search-input"),o.on("click",y),o.track({module_id:"portfolio",is_unique:!0,data:null}),o.dialog("open")})["catch"](function(a){})}function i(a){a.forEach(function(a){s.push(a),n["default"].proposal_open_contract.subscribe(a.contract_id)["catch"](function(a){l["default"].growl.error({message:a.message})})})}function j(a){var b=a.map(function(a){return n["default"].proposal_open_contract.forget(a.contract_id)["catch"](function(a){l["default"].growl.error({message:a.message})})}),c=_.map(a,"contract_id");return s=s.filter(function(a){return _.includes(c,a.contract_id)===!1}),Promise.all(b)}Object.defineProperty(a,"__esModule",{value:!0}),a.proposal_open_contract=a.init=void 0;var k=f(b),l=f(c),m=f(d),n=f(e),o=null,p=null,q=null,r="USD",s=[],t=a.init=function(a){a.click(function(){o?o.moveToTop():h()})},u=function(a){var b=a.proposal_open_contract,c=b.contract_id,d=b.bid_price;if(p){var e=p.api().row("#"+c),f=e.data();if(!f)return;var g=f[3];f[3]=d,e.data(f);var h=p.find("#"+c);b.is_valid_to_sell?(h.removeClass("resale-not-offered"),g!==d&&h.removeClass("indicative-red indicative-green").addClass(1*d>1*g?"indicative-green":"indicative-red")):h.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}},v=!1,w=0;n["default"].events.on("logout",function(){v=!1,w=0});var x=function B(a){if("subscribe"===a)++w,!v&&w>0&&n["default"].send({proposal_open_contract:1,subscribe:1}).then(function(){v=!0})["catch"](function(a){l["default"].growl.error({message:a.message})});else if("forget"===a)--w,v&&0===w&&n["default"].send({forget_all:"proposal_open_contract"}).then(function(){v=!1})["catch"](function(a){v=!1});else{if("resubscribe"!==a)return;n["default"].send({forget_all:"proposal_open_contract"}).then(function(){v=!1,--w,B("subscribe")})["catch"](function(a){v=!1})}},y=function(a){var b=a.target,c=l["default"](b);if("BUTTON"===b.tagName&&!c.hasClass("button-disabled")){var d=b.parentElement.parentElement,e=p.api().row(d).data();e=_.last(e),c.addClass("button-disabled"),require(["viewtransaction/viewTransaction"],function(a){a.init(e.contract_id,e.transaction_id).then(function(){c.removeClass("button-disabled")})})}},z=function(){var a=g(k["default"].mark(function b(){var a,c,d,e,f;return k["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return a=l["default"]("#"+p.attr("id")+"_processing").show(),b.prev=1,b.next=4,n["default"].send({portfolio:1});case 4:c=b.sent,d=c.portfolio&&c.portfolio.contracts,e="<button>View</button>".i18n(),f=d.map(function(a){return[a.transaction_id,a.longcode,a.buy_price,"0.00",e,a.contract_id,a]}),d.forEach(function(a){return n["default"].sell_expired(a.expiry_time)}),i(d),p.api().rows().remove(),p.api().rows.add(f),p.api().draw(),a.hide(),b.next=23;break;case 16:b.prev=16,b.t0=b["catch"](1),p.api().rows().remove(),p.api().draw(),a.hide(),l["default"].growl.error({message:b.t0.message});case 23:case"end":return b.stop()}},b,this,[[1,16]])}));return function(){return a.apply(this,arguments)}}(),A=a.proposal_open_contract={subscribe:function(){x("subscribe")},forget:function(){x("forget")},resubscribe:function(){x("resubscribe")}};a["default"]={init:t,proposal_open_contract:A}});