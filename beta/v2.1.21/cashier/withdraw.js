define(["exports","jquery","websockets/binary_websockets","windows/windows","common/rivetsExtra","cashier/currency","lodash","moment"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){return a&&a.__esModule?a:{"default":a}}function j(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(a,"__esModule",{value:!0});{var k=i(b),l=i(c),m=i(d),n=i(e),o=i(f),p=i(g);i(h)}require(["text!cashier/withdraw.html"]),require(["css!cashier/withdraw.css"]);var q=null,r=null,s=function(a){k["default"].growl.error({message:a.message})},t=function u(){var a=this;j(this,u),this.init=function(b){b.click(function(){q?q.moveToTop():l["default"].cached.authorize().then(function(a){return a.authorize.currency?!0:o["default"].check_currency()}).then(function(){return require(["text!cashier/withdraw.html"],a._init_win)})["catch"](s)})},this._init_win=function(b){b=k["default"](b).i18n(),q=m["default"].createBlankWindow(b,{title:"Withdraw funds",resizable:!0,collapsable:!1,minimizable:!0,maximizable:!0,width:700,height:400,"data-authorized":!0,close:function(){q.dialog("destroy"),q.trigger("dialogclose"),q.remove(),q=null},open:function(){},destroy:function(){r&&r.unbind(),r=null}}),a._init_state(b),q.dialog("open");var c=q.dialog("widget").offset();c.top=110,q.dialog("option","position",{my:c.left,at:c.top}),q.dialog("widget").css({left:c.left+"px",top:c.top+"px"}),q.fixFooterPosition(),q.track({module_id:"withdraw",is_unique:!0})},this._init_state=function(a){var b={route:{value:"menu"},empty_fields:{validate:!1,clear:p["default"].debounce(function(){return b.empty_fields.validate=!1},4e3),show:function(){b.empty_fields.validate=!0,b.empty_fields.clear()}},menu:{choice:""},verify:{token:"",code:"",disabled:!1},transfer:{disabled:!1,account:"",amount:"",loginid:local_storage.get("authorize").loginid},standard:{url:"",iframe_visible:!1},agent:{disabled:!1,loginid:"",name:"",agents:[],commission:"",amount:"",currency:local_storage.get("authorize").currency,residence:"",instructions:""},login_details:Cookies.loginids().reduce(function(a,b){return a.id==local_storage.get("authorize").loginid?a:b})},c=b.route,d=b.menu,e=b.verify,f=b.empty_fields,g=b.standard,h=b.agent,i=b.transfer,j={menu:400,verify:400,transfer:400,"transfer-done":300,standard:400,agent:550,"agent-confirm":400,"agent-done":300};c.update=function(a){c.value=a,q.dialog("option","height",j[a])},d.click=function(a){if(d.choice=a,c.update("transfer"!==a?"verify":"transfer"),"transfer"!==a){var b=local_storage.get("authorize").email,e="agent"===a?"paymentagent_withdraw":"payment_withdraw";l["default"].send({verify_email:b,type:e}).then(function(){return k["default"].growl.notice({message:"Verification code sent to ".i18n()+b})})["catch"](function(a){s(a),c.update("menu")})}},e.back=function(){e.token=e.code="",c.update("menu")},e.unlock=function(){return e.token?void("standard"===d.choice?(e.disabled=!0,l["default"].send({cashier:"withdraw",verification_code:e.token}).then(function(a){if(a.cashier.startsWith("ASK_"))throw new Error(a.cashier);g.url=a.cashier,e.disabled=!1,c.update("standard"),e.code=e.token,e.token=""})["catch"](function(a){e.disabled=!1,s(a)})):"agent"==d.choice&&(e.code=e.token,e.token="",c.update("agent"))):void f.show()},g.iframe_loaded=function(){g.url&&(g.iframe_visible=!0)},h.onchanged=function(){if(h.loginid){var a=h.agents.find(function(a){return a.paymentagent_loginid==h.loginid}),b=a.withdrawal_commission,c=a.name;h.commission=b,h.name=c}else h.commission="",h.name=""},h.amount_with_commission=function(){var a=(h.amount||0)*(100-h.commission)/100;return a.toFixed(2)},h.click=function(){return h.loginid?h.amount>=10&&h.amount<=2e3?h.instructions?void c.update("agent-confirm"):void f.show():void k["default"].growl.error({message:"Amount Min: 10 Max: 2000".i18n()}):void k["default"].growl.error({message:"Please select a payment agent".i18n()})},h.confirm_transfer=function(){var a={paymentagent_withdraw:1,paymentagent_loginid:h.loginid,currency:h.currency,amount:1*h.amount,verification_code:e.code};h.disabled=!0,l["default"].send(a).then(function(){c.update("agent-done"),h.disabled=!1})["catch"](function(a){h.disabled=!1,c.update("menu"),s(a)})},i.submit=function(){if(""===i.account||""===i.amount)return void f.show();var a={transfer_between_accounts:1,account_from:i.loginid,account_to:i.account,currency:h.currency,amount:i.amount};i.disabled=!0,l["default"].send(a).then(function(a){return 0===a.transfer_between_accounts?void k["default"].growl.error({message:"Transfering funds between accounts failed".i18n()}):void c.update("transfer-done")})["catch"](function(a){s(a),i.disabled=!1})},l["default"].send({get_settings:1}).then(function(a){return h.residence=a.get_settings.country_code,l["default"].cached.send({paymentagent_list:h.residence})}).then(function(a){h.agents=a.paymentagent_list.list})["catch"](s),l["default"].send({payout_currencies:1}).then(function(a){h.currency=a.payout_currencies[0]})["catch"](function(a){return void 0}),r=n["default"].bind(a[0],b)}};a["default"]=new t});