define(["exports","jquery","moment","lokijs","./chartingRequestMap","../websockets/stream_handler","datatables"],function(a,b,c,d,e,f){"use strict";function g(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var h=g(b),i=g(c),j=(g(d),g(e)),k=g(f),l=j["default"].barsTable,m=function(a,b,c){var d=a.find(".table-view"),e=a.find(".chart-view");a.find("span.close").css("display","block"),d.animate({left:"0"},250),e.animate({left:"-100%"},250),p(a,b,c);var f=d.find("table").DataTable();f.columns.adjust().draw(),a.view_table_visible=!0},n=function(a){var b=a.find(".table-view"),c=a.find(".chart-view");a.find("span.close").css("display","none"),b.animate({left:"100%"},250),c.animate({left:"0"},250),a.view_table_visible=!1},o=function(a,b){var c=[{title:"Date",orderable:!1,render:function(a){return i["default"].utc(a).utcOffset(b).format("YYYY-MM-DD HH:mm:ss")}},{title:"Open",orderable:!1},{title:"High",orderable:!1},{title:"Low",orderable:!1},{title:"Close",orderable:!1},{title:"Change",orderable:!1},{title:"",orderable:!1}],d=[0,1,2,3,4,5];return a&&(c=[{title:"Date",orderable:!1,render:function(a){return i["default"].utc(a).utcOffset(b).format("YYYY-MM-DD HH:mm:ss")}},{title:"Tick",orderable:!1},{title:"Change",orderable:!1},{title:"",orderable:!1}],d=[0,1,2]),{columns:c,columnIndexes:d}},p=function(a,b,c){var d=a.find("#"+a.attr("id")+"_chart").data(),e=isTick(d.timePeriod),f=a.find(".table-view"),g=l.chain().find({instrumentCdAndTp:j["default"].keyFor(b,d.timePeriod)}).simplesort("time",!0).limit(100).data(),h=0,i=g.map(function(a){var b=h==g.length-1?g[h]:g[h+1];if(h++,e){var c=q(b.open,a.open);return[a.time,a.open,c.value,c.image]}var d=q(b.close,a.close);return[a.time,a.open,a.high,a.low,a.close,d.value,d.image]}),k=f.find("table").DataTable();k.rows().remove(),k.destroy(),f.find("table *").remove();var m=o(e,c);f.find("table").dataTable({data:[],columns:m.columns,paging:!1,ordering:!0,info:!1,order:[0,"desc"],columnDefs:[{className:"dt-head-center dt-body-center",targets:m.columnIndexes}]}).parent().addClass("hide-search-input"),k=f.find("table").DataTable(),k.rows.add(i),k.draw()},q=function(a,b){var c=toFixed(Math.abs(a-b),4),d=toFixed(Math.abs(a-b)/Math.abs(a)*100,2);return b>=a?{value:c+"("+d+"%)",image:0===c?"":'<img src="images/blue_up_arrow.svg" class="arrow-images"/>'}:{value:'<span style="color:brown">'+c+"("+d+"%) </span>",image:0===c?"":'<img src="images/orange_down_arrow.svg" class="arrow-images"/>'}},r=a.init=function(a,b){b=b?-1*b:0;var c=a.find(".table-view"),d=a.find("#"+a.attr("id")+"_chart").data(),e=isTick(d.timePeriod),f=a.find("span.close");f.on("click",n.bind(null,a));var g=h["default"]("<table class='portfolio-dialog hover'/>");g.appendTo(c);var i=o(e,b);g=g.dataTable({data:[],columns:i.columns,paging:!1,ordering:!0,info:!1,order:[0,"desc"],columnDefs:[{className:"dt-head-center dt-body-center",targets:i.columnIndexes}]}),g.parent().addClass("hide-search-input");var l=k["default"].events.on("tick",function(b){if(b.key===j["default"].keyFor(d.instrumentCode,d.timePeriod)&&a.view_table_visible){var c=b.tick,e=q(b.preTick.open,c.open),f=[c.time,c.open,e.value,e.image];g.api().row.add(f),g.api().draw()}}),p=k["default"].events.on("ohlc",function(b){if(b.key===j["default"].keyFor(d.instrumentCode,d.timePeriod)&&a.view_table_visible){var c=b.ohlc,e=q(b.preOhlc.close,c.close),f=[c.time,c.open,c.high,c.low,c.close,e.value,e.image];if(b.is_new)g.api().row.add(f);else{var h=g.api().rows()[0][0];g.api().row(h).data(f)}g.api().draw()}});return a.on("dialogdestroy",function(){k["default"].events.off("tick",l),k["default"].events.off("ohlc",p)}),{show:m.bind(null,a,d.instrumentCode,b),hide:n.bind(null,a)}};a["default"]={init:r}});