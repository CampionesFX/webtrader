define(["exports","jquery","./binary_websockets","../charts/chartingRequestMap","common/util"],function(a,b,c,d){"use strict";function e(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.events=void 0;var f=e(b),g=e(c),h=e(d),i=h["default"].barsTable,j=function(a,b,c){a.xAxis.forEach(function(a){b||(b=a.getExtremes().min),c||(c=a.getExtremes().max),a.setExtremes(b,c)})};g["default"].events.on("tick",function(a){var b=a.echo_req.ticks_history+a.echo_req.granularity;if(b&&h["default"][b.toUpperCase()]){b=b.toUpperCase();var c=parseFloat(a.tick.quote),d=1e3*parseInt(a.tick.epoch),e=h["default"][b],g=a.echo_req.granularity||0;if(e.id=e.id||a.tick.id,0===g){var j={instrumentCdAndTp:b,time:d,open:c,high:c,low:c,close:c,price:a.tick.quote};i.insert(j);var k=j,m=i.chain().find({instrumentCdAndTp:b}).simplesort("time",!0).limit(2).data();if(m.length>1&&(k=m[1]),l("tick",{tick:j,key:b,preTick:k}),!(e.chartIDs&&e.chartIDs.length>0))return;for(var n=0;n<e.chartIDs.length;n++){var o=e.chartIDs[n],p=f["default"](o.containerIDWithHash).highcharts();if(!p)return;var q=p.get(b);if(!q)return;q.addPoint([d,c])}}}}),g["default"].events.on("ohlc",function(a){var b=a.ohlc.symbol+a.ohlc.granularity;if(b&&h["default"][b.toUpperCase()]){b=b.toUpperCase(),f["default"](document).trigger("feedTypeNotification",[b,"realtime-feed"]);var c=parseFloat(a.ohlc.open),d=parseFloat(a.ohlc.high),e=parseFloat(a.ohlc.low),g=parseFloat(a.ohlc.close),k=1e3*parseInt(a.ohlc.open_time),m=h["default"][b];if(m.id=m.id||a.ohlc.id,!(m.chartIDs&&m.chartIDs.length>0))return;var n=f["default"](m.chartIDs[0].containerIDWithHash).data("timePeriod");if(!n)return;var o=i.chain().find({$and:[{instrumentCdAndTp:b},{time:k}]}).simplesort("time",!0).limit(1).data(),p=!1;!o||o.length<=0?(o={instrumentCdAndTp:b,time:k,open:c,high:d,low:e,close:g},i.insert(o),p=!0):(o=o[0],o.open=c,o.high=d,o.low=e,o.close=g,i.update(o));var q=o,r=i.chain().find({instrumentCdAndTp:b}).simplesort("time",!0).limit(2).data();r.length>1&&(q=r[1]),l("ohlc",{ohlc:o,is_new:p,key:b,preOhlc:q});for(var s=0;s<m.chartIDs.length;s++){var t=m.chartIDs[s],u=f["default"](t.containerIDWithHash).highcharts();if(!u)return;var v=u.get(b);if(!v)return;var w=f["default"](t.containerIDWithHash).data("type"),x=v.data[v.data.length-1];if(v.options.data.length!=v.data.length)return void j(u,null,o.time);w&&isDataTypeClosePriceOnly(w)?p?v.addPoint([k,g],!0,!0,!1):x.update({y:g}):p?v.addPoint([k,c,d,e,g],!0,!0,!1):x.update({open:c,high:d,low:e,close:g})}}});var k={},l=function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];var e=k[a]||[];e.forEach(function(a){return setTimeout(function(){return a.apply(void 0,c)},0)})},m=a.events={on:function(a,b){return(k[a]=k[a]||[]).push(b),b},off:function(a,b){if(k[a]){var c=k[a].indexOf(b);-1!==c&&k[a].splice(c,1)}}};a["default"]={events:m}});