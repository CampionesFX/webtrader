define(["jquery","jquery-ui","websockets/binary_websockets","navigation/menu","charts/chartWindow","jquery-growl","common/util"],function(a,b,c,d,e){"use strict";function f(){c.send({active_symbols:"brief"}).then(function(b){{var c=[];_(b.active_symbols).groupBy("market").map(function(a){var b=_.head(a),d={name:b.market,display_name:b.market_display_name};return d.submarkets=_(a).groupBy("submarket").map(function(a){var b=_.head(a),d={name:b.submarket,display_name:b.submarket_display_name};return d.instruments=_.map(a,function(a){return c.push(a.symbol),{symbol:a.symbol,display_name:a.display_name}}),d}).value(),d}).value()}h=i.map(function(a){return{display_name:a.display_name,name:a.name,submarkets:a.submarkets.map(function(a){return{display_name:a.display_name,instruments:a.instruments.filter(function(a){return-1!==c.indexOf(a.symbol)})}}).filter(function(a){return 0!==a.instruments.length})}}).filter(function(a){return 0!==a.submarkets.length}),h=d.sortMenu(h);var e=a("#nav-menu").find(".instruments");e.find("> ul").remove();var f=a("<ul>").appendTo(e);d.refreshMenu(f,h,g)})}function g(a){var b=a.data("delay_amount"),c=a.data("symbol"),d=a.data("display_name");e.addNewWindow({instrumentCode:c,instrumentName:d,timePeriod:"1d",type:"candlestick",delayAmount:b})}var h=[],i=[];return{init:function(){return c.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(b){i=d.extractChartableMarkets(b),f(),require(["websockets/binary_websockets"],function(a){a.events.on("login",f),a.events.on("logout",f)});a("#nav-menu").find(".instruments").on("mouseleave",f);return i})},getMarketData:function(){return h},isMarketDataPresent:function(b,c){var d=!1;c||(c=h);var e=this;return a.each(c,function(c,f){return f.submarkets||f.instruments?d=e.isMarketDataPresent(b,f.submarkets||f.instruments):a.trim(f.display_name)==a.trim(b)&&(d=!0),!d}),d},getSpecificMarketData:function(b,c){var d={};c||(c=h);var e=this;return a.each(c,function(c,f){return f.submarkets||f.instruments?d=e.getSpecificMarketData(b,f.submarkets||f.instruments):a.trim(f.display_name)==a.trim(b)&&(d=f),a.isEmptyObject(d)}),d}}});